import tenseal as ts
import base64
import requests
import time
import json
import psutil
import os
from typing import Dict, Any, Tuple, Optional

class CKKSBaseline:
    def __init__(self):
        self.context = None
    
    def load_server_public_key(self, key_file_path):
        """ì„œë²„ ê³µê°œí‚¤ë¡œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""
        try:
            # ë°”ì´ë„ˆë¦¬ íŒŒì¼ ì½ê¸°
            with open(key_file_path, 'rb') as f:
                public_key_bytes = f.read()
            
            # ì„œë²„ ê³µê°œí‚¤ë¡œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
            self.context = ts.context_from(public_key_bytes)
            print(f"âœ… ì„œë²„ ê³µê°œí‚¤ ë¡œë“œ: {len(public_key_bytes):,} bytes")
            return True
        except Exception as e:
            print(f"âŒ ê³µê°œí‚¤ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return False
    
    def encrypt_value(self, value):
        """ì„œë²„ í‚¤ë¡œ ì•”í˜¸í™”"""
        if self.context is None:
            raise ValueError("ì„œë²„ ê³µê°œí‚¤ë¥¼ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”")
        
        encrypted = ts.ckks_vector(self.context, [float(value)])
        encrypted_hex = encrypted.serialize().hex()
        encrypted_size = len(encrypted.serialize())
        
        return encrypted_hex, encrypted_size
    
    def generate_proof(self, sensor_value: float, algorithm: str = "CKKS") -> Dict[str, Any]:
        """ì„¼ì„œ ê°’ì— ëŒ€í•œ CKKS ì¦ëª… ìƒì„±"""
        if self.context is None:
            raise ValueError("ì„œë²„ ê³µê°œí‚¤ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”")
        
        start_time = time.time()
        
        try:
            # ì•”í˜¸í™”
            encrypted_hex, encrypted_size = self.encrypt_value(sensor_value)
            encrypted_base64 = base64.b64encode(bytes.fromhex(encrypted_hex)).decode('utf-8')
            
            end_time = time.time()
            total_time = (end_time - start_time) * 1000
            
            # Context íŒŒë¼ë¯¸í„° ì •ë³´
            context_params = {
                "poly_modulus_degree": 4096,
                "coeff_mod_bit_sizes": [40, 20, 40],
                "scale": 1048576,
                "context_id": "lightweight"
            }
            
            proof_data = {
                "encrypted_data": encrypted_base64,
                "context": "shared",  # ì‚¬ì „ ê³µìœ  context ì‚¬ìš© í‘œì‹œ
                "context_id": "lightweight",  # ì„œë²„ í•„ìˆ˜ í•„ë“œ
                "context_params": context_params,  # ì„œë²„ ê²€ì¦ìš© íŒŒë¼ë¯¸í„°
                "algorithm": algorithm,
                "sensor_value": sensor_value,  # ê²€ì¦ìš© (ì‹¤ì œ ë°°í¬ì—ì„œëŠ” ì œì™¸)
                "generation_time_ms": total_time,
                "encrypted_size_bytes": len(bytes.fromhex(encrypted_hex)),
                "timestamp": int(time.time()),
                "privacy_level": "full_homomorphic",
                "security_strength": "128-bit"
            }
            
            return proof_data
            
        except Exception as e:
            print(f"âŒ CKKS proof generation failed: {e}")
            raise e

    # ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ë©”ì„œë“œë“¤
    def load_server_public_key_from_file(self, file_path):
        """ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ë˜í¼"""
        return self.load_server_public_key(file_path)
    
    def load_server_public_key_from_api(self, server_url='http://192.168.0.11:8085'):
        """ì„œë²„ APIì—ì„œ ê³µê°œí‚¤ ìë™ ë‹¤ìš´ë¡œë“œ"""
        try:
            import requests
            import base64
            
            # ê³µê°œí‚¤ API í˜¸ì¶œ (ì˜¬ë°”ë¥¸ URL)
            response = requests.get(f'{server_url}/api/v1/ckks/public-key')
            
            if response.status_code == 200:
                data = response.json()
                public_key_base64 = data['public_key']
                public_key_bytes = base64.b64decode(public_key_base64)
                
                # ì„œë²„ ê³µê°œí‚¤ë¡œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
                self.context = ts.context_from(public_key_bytes)
                
                print(f"âœ… ì„œë²„ ê³µê°œí‚¤ ë¡œë“œ ì„±ê³µ")
                print(f"ğŸ“Š í¬ê¸°: {len(public_key_bytes):,} bytes")
                print(f"ğŸ”‘ Context ID: {data.get('context_id', 'unknown')}")
                return True
            else:
                print(f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"âŒ ê³µê°œí‚¤ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return False